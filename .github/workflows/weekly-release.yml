name: Weekly Release

on:
  schedule:
    - cron: "0 12 * * 1" # Every Monday at 12:00 PM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  check-for-new-commits:
    name: Check for New Commits
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      last_tag: ${{ steps.check.outputs.last_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history and tags

      - name: Check for new commits since last release
        id: check
        run: |
          set -euo pipefail

          # Fetch all tags
          git fetch --tags

          # Get the latest semantic version tag
          LAST_TAG=$(git tag --sort=-v:refname -l "v[0-9]*.[0-9]*.[0-9]*" | head -n 1)

          if [ -z "$LAST_TAG" ]; then
              echo "No previous release tag found. Releasing."
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "last_tag=" >> $GITHUB_OUTPUT # Ensure output is set even if empty
              exit 0
          fi

          echo "Last release tag: $LAST_TAG"
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT # Output the last tag

          # Get the commit hash of the last tag
          LAST_TAG_COMMIT=$(git rev-list -n 1 "$LAST_TAG")

          # Get the latest commit on main
          MAIN_HEAD_COMMIT=$(git rev-parse HEAD)

          echo "Last tag commit: $LAST_TAG_COMMIT"
          echo "Main HEAD commit: $MAIN_HEAD_COMMIT"

          # Check if main has new commits since the last tag
          # git rev-list LAST_TAG_COMMIT..MAIN_HEAD_COMMIT returns commits on MAIN_HEAD_COMMIT that are not on LAST_TAG_COMMIT
          NEW_COMMITS=$(git rev-list "$LAST_TAG_COMMIT".."$MAIN_HEAD_COMMIT" --count)

          if [ "$NEW_COMMITS" -gt 0 ]; then
              echo "Main has $NEW_COMMITS new commits since $LAST_TAG. Releasing."
              echo "should_release=true" >> $GITHUB_OUTPUT
          else
              echo "No new commits on main since $LAST_TAG. Skipping release."
              echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: check-for-new-commits
    if: needs.check-for-new-commits.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Verify build environment
        run: |
          echo "Build environment ready. Proceeding with release..."

      - name: Pre-release build verification
        run: pnpm run build

      - name: Create minor version release
        id: create-release-info
        run: |
          set -euo pipefail
          # Get current version
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          # Bump to next minor version
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          NEXT_VERSION="${PARTS[0]}.$((PARTS[1] + 1)).0"
          NEXT_VERSION_TAG="v$NEXT_VERSION"

          echo "Creating release: $CURRENT_VERSION â†’ $NEXT_VERSION"

          # Output NEXT_VERSION_TAG
          echo "next_version_tag=$NEXT_VERSION_TAG" >> $GITHUB_OUTPUT

          # Update version
          npm version $NEXT_VERSION --no-git-tag-version

          # Create tag
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add package.json
          git commit -m "chore: bump version to $NEXT_VERSION_TAG"
          git tag "$NEXT_VERSION_TAG"
          git push origin "$NEXT_VERSION_TAG"

      - name: Prepare Release Notes
        id: prepare-notes
        run: |
          set -euo pipefail

          LAST_TAG="${{ needs.check-for-new-commits.outputs.last_tag }}"
          NEXT_VERSION_TAG="${{ steps.create-release-info.outputs.next_version_tag }}"

          echo "Preparing release notes from $LAST_TAG to $NEXT_VERSION_TAG"

          DEPENDENCY_UPDATES=""
          OTHER_COMMITS=""

          # Get all commits between last tag and current HEAD (which is the new tag)
          # Using git log --pretty=format:"- %s" to get commit messages
          COMMITS_RANGE="$LAST_TAG"..HEAD

          # If LAST_TAG is empty (first release), get all commits up to HEAD
          if [ -z "$LAST_TAG" ]; then
            COMMITS_RANGE="HEAD" # Get all commits up to HEAD (if no previous tag)
          fi

          ALL_COMMITS=$(git log --pretty=format:"- %s" "$COMMITS_RANGE")

          # Loop through commits and categorize
          while IFS= read -r line; do
            if [[ "$line" =~ ^-\ (chore\(deps\)|fix\(deps\)|feat\(deps\)|build\(deps\)|ci\(deps\)|refactor\(deps\)):.* || "$line" =~ ^-\ Renovate.* ]]; then
              DEPENDENCY_UPDATES+="$line"$'
            else
              OTHER_COMMITS+="$line"$'
            fi
          done <<< "$ALL_COMMITS"

          RELEASE_BODY="## Automated Weekly Release"

          if [ -n "$DEPENDENCY_UPDATES" ]; then
            RELEASE_BODY+=$'\n\n'"### Dependency Updates"$'
            RELEASE_BODY+="$DEPENDENCY_UPDATES"
          fi

          if [ -n "$OTHER_COMMITS" ]; then
            RELEASE_BODY+=$'\n\n'"### Other Changes"$'
            RELEASE_BODY+="$OTHER_COMMITS"
          fi

          echo "Generated Release Body:"
          echo "$RELEASE_BODY"
          # Set the output for the release body
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Weekly Release ${{ steps.create-release-info.outputs.next_version_tag }}"
          tag_name: ${{ steps.create-release-info.outputs.next_version_tag }}
          body: ${{ steps.prepare-notes.outputs.body }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
